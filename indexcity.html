<!DOCTYPE html>
<html>
<head>
  <title>Ijtima Performance Data</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['table']});
    google.charts.setOnLoadCallback(init);

    // Replace with your actual Google Sheet ID
    let sheetUrl = 'https://docs.google.com/spreadsheets/d/11FCt-Uhffya434cBpGsNyotV1dUrMP_hkpeoLjYisdo/gviz/tq?sheet=Sheet1&headers=1';

    let allData;

    function init() {
      loadData();
    }

    function loadData(monthFilter = '', dateFilter = '', cityFilter = '') {
      // Columns D = Month/Year, E = Date, F = City, Gâ€“O = metrics
      let queryString = "SELECT D, E, F, G, H, I, J, K, L, M, N, O";

      let conditions = [];
      if (monthFilter) conditions.push("D = '" + monthFilter + "'");
      if (dateFilter) conditions.push("E = date '" + dateFilter + "'");
      if (cityFilter) conditions.push("F = '" + cityFilter + "'");

      if (conditions.length > 0) queryString += " WHERE " + conditions.join(" AND ");

      let query = new google.visualization.Query(sheetUrl + "&tq=" + encodeURIComponent(queryString));
      query.send(handleQueryResponse);
    }

    function handleQueryResponse(response) {
      if (response.isError()) {
        alert('Error: ' + response.getMessage());
        return;
      }
      let data = response.getDataTable();
      allData = data;

      // Rename columns for readability
      data.setColumnLabel(0, "Month & Year");
      data.setColumnLabel(1, "Date (Friday)");
      data.setColumnLabel(2, "City");
      data.setColumnLabel(3, "Number of Participants");
      data.setColumnLabel(4, "Invitation through calls");
      data.setColumnLabel(5, "Intentions before Tilawat");
      data.setColumnLabel(6, "Intentions before Naat");
      data.setColumnLabel(7, "Duration of Bayan (minutes)");
      data.setColumnLabel(8, "Was Madani Halqa Conducted?");
      data.setColumnLabel(9, "Was Sunnahs and Manners taught?");
      data.setColumnLabel(10, "Was Learning/Memorizing Dua conducted?");
      data.setColumnLabel(11, "Was Pious Deed Booklet filled with everyone?");

      let table = new google.visualization.Table(document.getElementById('table_div'));
      table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});

      populateFilters(allData);
    }

    function populateFilters(data) {
      let months = new Set();
      let dates = new Set();
      let cities = new Set();

      for (let i = 0; i < data.getNumberOfRows(); i++) {
        months.add(data.getValue(i, 0)); // Column D
        dates.add(data.getValue(i, 1));  // Column E
        cities.add(data.getValue(i, 2)); // Column F
      }

      let monthSelect = document.getElementById('monthFilter');
      monthSelect.innerHTML = '<option value="">All Months</option>';
      months.forEach(m => monthSelect.innerHTML += `<option value="${m}">${m}</option>`);

      let dateSelect = document.getElementById('dateFilter');
      dateSelect.innerHTML = '<option value="">All Dates</option>';
      dates.forEach(d => dateSelect.innerHTML += `<option value="${d}">${d}</option>`);

      let citySelect = document.getElementById('cityFilter');
      citySelect.innerHTML = '<option value="">All Cities</option>';
      cities.forEach(c => citySelect.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function applyFilters() {
      let month = document.getElementById('monthFilter').value;
      let date = document.getElementById('dateFilter').value;
      let city = document.getElementById('cityFilter').value;
      loadData(month, date, city);
    }

    function resetFilters() {
      document.getElementById('monthFilter').value = '';
      document.getElementById('dateFilter').value = '';
      document.getElementById('cityFilter').value = '';
      loadData();
    }
  </script>
</head>
<body>
  <h2>Ijtima Performance Data (Month + Date + City Filters)</h2>

  <label for="monthFilter">Month & Year:</label>
  <select id="monthFilter" onchange="applyFilters()"></select>

  <label for="dateFilter">Date (Friday):</label>
  <select id="dateFilter" onchange="applyFilters()"></select>

  <label for="cityFilter">City:</label>
  <select id="cityFilter" onchange="applyFilters()"></select>

  <button onclick="resetFilters()">Reset Filters</button>

  <div id="table_div"></div>
</body>
</html>
