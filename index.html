<!DOCTYPE html>
<html>
<head>
  <title>Ijtima Performance Data</title>
  <meta charset="utf-8">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    h2 { margin-bottom: 12px; }
    .filters { display: flex; gap: 16px; flex-wrap: wrap; align-items: end; margin-bottom: 16px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .google-visualization-table-td {white-space: nowrap;}
    #loginDiv { margin-bottom: 20px; }
    #loading {
      display: none;
      margin: 15px 0;
      font-weight: bold;
      color: #0066cc;
      text-align: center;
    }  

#modifyModal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 20px;
  border: 2px solid #0066cc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1000;
}

#modifyModal h3 {
  margin-top: 0;
}

#modifyModal form label {
  display: block;
  margin: 8px 0;
}

#modifyModal button {
  margin-right: 10px;
}

body::before {
  content: "";
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

#modifyModal[style*="display: block"] ~ body::before {
  display: block;
}
   .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
  
<body>
  <h2>Ijtima Performance Data (Month â†’ Date â†’ State â†’ City)</h2>

  <!-- Login Form -->
  <div id="loginDiv">
    <h3>Login</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- Dashboard (hidden until login) -->
  <div id="dashboardDiv" style="display:none;">
    <button id="logoutBtn">Logout</button>
    <div class="filters">
      <div class="field">
        <label for="yearFilter">Year</label>
        <select id="yearFilter"></select>
      </div>
      <div class="field">
        <label for="monthFilter">Month & Year</label>
        <select id="monthFilter"></select>
      </div>
      <div class="field">
        <label for="dateFilter">Date (Friday)</label>
        <select id="dateFilter"></select>
      </div>
      <div class="field">
        <label for="stateFilter">State</label>
        <select id="stateFilter"></select>
      </div>
      <div class="field">
        <label for="cityFilter">City</label>
        <select id="cityFilter"></select>
      </div>
      <div class="spacer"></div>
      <button onclick="resetFilters()">Reset Filters</button>
    </div>

  <div id="modifyModal" style="display:none;">
  <h3>Modify Row</h3>
  <form id="modifyForm">
    <label>Number of Participants <input id="modParticipants"></label>
    <label>Invitation through calls <input id="modCalls"></label>
    <label>Intentions before Tilawat <input id="modTilawat"></label>
    <label>Intentions before Naat <input id="modNaat"></label>
    <label>Duration of Bayan (minutes) <input id="modBayan"></label>

    <!-- Dropdowns for Yes/No fields -->
    <label>Was Madani Halqa Conducted?
      <select id="modHalqa">
        <option value="">--Select--</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </label>

    <label>Was Sunnahs and Manners taught?
      <select id="modSunnahs">
        <option value="">--Select--</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </label>

    <label>Was Learning/Memorizing Dua conducted?
      <select id="modDua">
        <option value="">--Select--</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </label>

    <label>Was Pious Deed Booklet filled?
      <select id="modBooklet">
        <option value="">--Select--</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </label>

    <button type="submit">Save</button>
    <button type="button" onclick="closeModifyDialog()">Cancel</button>
  </form>
</div>  
    
    <div id="loading" style="display:none; margin:10px; font-weight:bold; color:#0066cc;">
      ðŸ”„ Refreshing data, please wait...
    </div>
        
    <!-- Table container -->
    <div id="table_div"></div>
    </div>

  <!-- Dashboard Logic -->
  <script type="module">
    import { login, logout, getUserStates, getUserProfile } from './auth.js';

    google.charts.load('current', {'packages':['table']});
    google.charts.setOnLoadCallback(init);
    document.getElementById('yearFilter').addEventListener('change', onYearChange);
    document.getElementById('monthFilter').addEventListener('change', onMonthChange);
    document.getElementById('dateFilter').addEventListener('change', onDateChange);
    document.getElementById('stateFilter').addEventListener('change', onStateChange);
    document.getElementById('cityFilter').addEventListener('change', onCityChange);

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/11FCt-Uhffya434cBpGsNyotV1dUrMP_hkpeoLjYisdo/gviz/tq?sheet=Sheet1&headers=1';

    const stateCityMap = {
      "California": ["Elk Grove, CA", "Riverside, CA", "Sacramento, CA", "Woodland, CA", "Yuba City, CA"],
      "Florida": ["Miami, FL", "Tampa, FL"],
      "Georgia": ["Lilburn, GA"],
      "Illinois": ["Chicago, IL", "Lombard, IL", "Bloomington, IL", "Skokie, IL", "Schaumburg, IL"],
      "Louisiana": ["New Orleans, LA", "St. Rose, LA"],
      "Maryland": ["Baltimore, MD", "Ellicot City, MD"],
      "New York": ["Bronx, NY", "Brooklyn, NY", "Long Island, NY", "Queens, NY", "Valley Stream, NY"],
      "Pennsylvania": ["Langhorne, PA"],
      "Texas": ["Sugar Land, TX", "Wylie, TX"],
      "Virginia": ["Woodbridge, VA"],
      "Washington": ["Lynnwood, WA"]
    };

    // --- Helper: derive State from City ---
function getStateFromCity(city) {
  const normalizedCity = String(city || "").toLowerCase().trim();
  if (!normalizedCity) return "";

  for (const [state, cities] of Object.entries(stateCityMap)) {
    if (cities.some(c => String(c || "").toLowerCase().trim() === normalizedCity)) {
      return state;
    }
  }
  return "";
}
    
    // Normalized map (lowercase keys and city names)
    const normalizedStateCityMap = (() => {
      const map = {};
      Object.keys(stateCityMap).forEach(k => {
        const key = k.toLowerCase().trim();
        map[key] = stateCityMap[k].map(c => c.toLowerCase().trim());
      });
      return map;
    })();


    let cachedFilters = { years: [], months: [], dates: [], cities: [] };
    let masterData = null;
    let table = null;
    const selections = { month: '', date: '', states: [], city: '', year: '' };

// --- Login Button ---
let currentUserEmail = ""; // declare at top of script
 
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  try {
    await login(email, password);
    currentUserEmail = email;
    console.log("Logged in as:", currentUserEmail);

    // Normalize states returned from auth.js
    const cleanStates = Array.from(
      new Set(getUserStates().map(s => s.toLowerCase().trim()).filter(Boolean))
    );

    const stateSel = document.getElementById('stateFilter');
    if (cleanStates.length > 0) {
      selections.states = cleanStates;

      // Populate dropdown with assigned states
      stateSel.innerHTML = '<option value="">All States</option>';
      cleanStates.forEach(st => {
        // Find pretty label from original map keys
        const pretty = Object.keys(stateCityMap).find(
          k => k.toLowerCase().trim() === st
        ) || st;
        stateSel.innerHTML += `<option value="${pretty}">${pretty}</option>`;
      });

      // Disable only if exactly one state is assigned
      stateSel.disabled = (cleanStates.length === 1);
    } else {
      alert("No assignedStates found in profile");
    }

    // Show dashboard
    document.getElementById('loginDiv').style.display = "none";
    document.getElementById('dashboardDiv').style.display = "block";

    // Build filters and draw table
    refreshFilterOptions();
    drawFilteredView(); // <-- this replaces the stray "();"

  } catch (err) {
    alert(err.message);
    console.error('Login error:', err);
  }
});

// --- Logout Button ---
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await logout();

  // Clear selections
  selections.states = [];
  selections.city = '';
  selections.month = '';
  selections.date = '';
  selections.year = '';

  // Reset state dropdown
  const stateSel = document.getElementById('stateFilter');
  stateSel.disabled = false;   // always reâ€‘enable on logout
  stateSel.value = '';
  stateSel.innerHTML = '<option value="">All States</option>';
  Object.keys(stateCityMap).forEach(state => {
    stateSel.innerHTML += `<option value="${state}">${state}</option>`;
  });

  // Hide dashboard, show login
  document.getElementById('loginDiv').style.display = "block";
  document.getElementById('dashboardDiv').style.display = "none";

  // Reset filters and redraw
  resetFilters();
});
    // --- Dashboard Initialization ---
    function init() {
      const queryString = "SELECT B, C, D, E, F, G, H, I, J, K, L, M, N, O, P";
      const query = new google.visualization.Query(sheetUrl + "&tq=" + encodeURIComponent(queryString));
      query.send(handleInitialResponse);
    }

    function handleInitialResponse(response) {
      if (response.isError()) {
        alert('Error loading data: ' + response.getMessage());
        return;
      }
      masterData = response.getDataTable();
      
      masterData.setColumnLabel(0, "Email");
      masterData.setColumnLabel(1, "Name");
      masterData.setColumnLabel(2, "Month & Year");
      masterData.setColumnLabel(3, "Date (Friday)");
      masterData.setColumnLabel(4, "City");
      masterData.setColumnLabel(5, "Number of Participants");
      masterData.setColumnLabel(6, "Invitation through calls");
      masterData.setColumnLabel(7, "Intentions before Tilawat");
      masterData.setColumnLabel(8, "Intentions before Naat");
      masterData.setColumnLabel(9, "Duration of Bayan (minutes)");
      masterData.setColumnLabel(10, "Was Madani Halqa Conducted?");
      masterData.setColumnLabel(11, "Was Sunnahs and Manners taught?");
      masterData.setColumnLabel(12, "Was Learning/Memorizing Dua conducted?");
      masterData.setColumnLabel(13, "Was Pious Deed Booklet filled with everyone?");

      table = new google.visualization.Table(document.getElementById('table_div'));
      populateStateFilter();
      refreshFilterOptions();
    }

    function getVal(data, row, col) {
      return data.getFormattedValue(row, col) || data.getValue(row, col);
    }

    function populateStateFilter() {
      const stateSel = document.getElementById('stateFilter');
      stateSel.innerHTML = '<option value="">All States</option>';
      Object.keys(stateCityMap).forEach(state => {
        stateSel.innerHTML += `<option value="${state}">${state}</option>`;
      });
    }

    function buildFilterCache() {
      if (!masterData) {
        console.warn("masterData not initialized yet");
        return;
      }  

      const years = new Set();
      const months = new Set();
      const dates = new Set();
      const cities = new Set();


  for (let r = 0; r < masterData.getNumberOfRows(); r++) {
    const m = getVal(masterData, r, 2); // "Month & Year"
    const d = getVal(masterData, r, 3); // Date (Friday)
    const c = getVal(masterData, r, 4); // City

    if (m) {
      const yearMatch = m.match(/\b\d{4}\b/);
      if (yearMatch) years.add(yearMatch[0]);

      if (!selections.year || m.includes(selections.year)) {
        months.add(m);
      }

      const year = yearMatch ? yearMatch[0] : '';
      const matchesYear = !selections.year || (year && year === selections.year);
      const matchesMonth = !selections.month || m.toLowerCase().trim() === selections.month.toLowerCase().trim();

      if (d && matchesYear && matchesMonth) {
        dates.add(d);
      }
      if (c && matchesYear && matchesMonth) {
        cities.add(c);
      }
    }
  }

  cachedFilters = {
    years: [...years].sort(),
    months: [...months].sort(),
    dates: [...dates].sort(),
    cities: [...cities].sort()
  };
}

// --- Helper: get allowed cities from assigned states ---
function getAllowedCitiesFromStates(states) {
  const set = new Set();
  (states || []).forEach(st => {
    const key = st.toLowerCase().trim();
    if (normalizedStateCityMap[key]) {
      normalizedStateCityMap[key].forEach(c => set.add(c));
    }
  });
  return set;
}


// --- Refresh dropdowns ---
function refreshFilterOptions() {
  buildFilterCache();

  const yearSel = document.getElementById('yearFilter');
  yearSel.innerHTML = '<option value="">All Years</option>';
  cachedFilters.years.forEach(y => {
    yearSel.innerHTML += `<option value="${y}"${selections.year === y ? ' selected' : ''}>${y}</option>`;
  });

  const monthSel = document.getElementById('monthFilter');
  monthSel.innerHTML = '<option value="">All Months</option>';
  cachedFilters.months.forEach(m => {
    monthSel.innerHTML += `<option value="${m}"${selections.month === m ? ' selected' : ''}>${m}</option>`;
  });

  const dateSel = document.getElementById('dateFilter');
  dateSel.innerHTML = '<option value="">All Dates</option>';
  cachedFilters.dates.forEach(d => {
    dateSel.innerHTML += `<option value="${d}"${selections.date === d ? ' selected' : ''}>${d}</option>`;
  });

  const citySel = document.getElementById('cityFilter');
  citySel.innerHTML = '<option value="">All Cities</option>';

  const allowedCities = getAllowedCitiesFromStates(selections.states);
  if (allowedCities.size > 0) {
    cachedFilters.cities.forEach(c => {
      if (allowedCities.has(c.toLowerCase().trim())) {
        citySel.innerHTML += `<option value="${escapeHtml(c)}"${selections.city === c ? ' selected' : ''}>${escapeHtml(c)}</option>`;
      }
    });
  } else {
    cachedFilters.cities.forEach(c => {
      citySel.innerHTML += `<option value="${escapeHtml(c)}"${selections.city === c ? ' selected' : ''}>${escapeHtml(c)}</option>`;
    });
  }
}

    
// --- Helper: calculate column widths based on content ---
function getColumnWidths(dataView) {
  const widths = [];
  for (let col = 0; col < dataView.getNumberOfColumns(); col++) {
    let maxLen = dataView.getColumnLabel(col).length;
    for (let row = 0; row < dataView.getNumberOfRows(); row++) {
      const val = dataView.getFormattedValue(row, col) || dataView.getValue(row, col);
      if (val && val.toString().length > maxLen) {
        maxLen = val.toString().length;
      }
    }
    // Roughly 8px per character, capped at 300px
    widths.push(Math.min(maxLen * 8, 300));
  }
  return widths;
}

// --- Draw filtered view with auto column widths ---
function drawFilteredView() {
  if (!masterData) {
    console.warn("masterData not initialized yet");
    return;
  }

  const view = new google.visualization.DataView(masterData);
  const rows = [];

  const allowedCities = getAllowedCitiesFromStates(selections.states);

  for (let r = 0; r < masterData.getNumberOfRows(); r++) {
    const m = getVal(masterData, r, 2); // Month & Year
    const d = getVal(masterData, r, 3); // Date (Friday)
    const c = getVal(masterData, r, 4); // City

    const match =
      (!selections.year || String(m || "").includes(selections.year)) &&
      (!selections.month || String(m || "").toLowerCase().trim() === selections.month.toLowerCase().trim()) &&
      (!selections.date || String(d || "").toLowerCase().trim() === selections.date.toLowerCase().trim()) &&
      (allowedCities.size === 0 || allowedCities.has(String(c || "").toLowerCase().trim())) &&
      (!selections.city || String(c || "").toLowerCase().trim() === selections.city.toLowerCase().trim());

    if (match) rows.push(r);
  }

  view.setRows(rows);

  const numCols = masterData.getNumberOfColumns();
  const cols = [];
  for (let i = 0; i < numCols - 1; i++) cols.push(i); // show all but RowID

  cols.push({
  type: 'string',
  label: 'Actions',
  calc: function (dt, row) {
    const rowId = dt.getValue(row, numCols - 1); // RowID
    const email = dt.getValue(row, 1);           // Email
    const name  = dt.getValue(row, 2);           // Name
    const city  = String(dt.getValue(row, 5) || "").trim();
    const state = getStateFromCity(city);
    const participants = dt.getValue(row, 6);
    const calls        = dt.getValue(row, 7);
    const tilawat      = dt.getValue(row, 8);
    const naat         = dt.getValue(row, 9);
    const bayan        = dt.getValue(row, 10);
    const halqa        = dt.getValue(row, 11);
    const sunnahs      = dt.getValue(row, 12);
    const dua          = dt.getValue(row, 13);
    const booklet      = dt.getValue(row, 14);

    return `
      <button class="delete-btn" onclick="deleteRow('${rowId}', '${name}', '${email}', '${state}')">Delete</button>
      <button class="modify-btn"
        onclick="openModifyDialog('${rowId}', '${state}',
          '${participants}', '${calls}', '${tilawat}', '${naat}',
          '${bayan}', '${halqa}', '${sunnahs}', '${dua}', '${booklet}')">
        Modify
      </button>
    `;
  }
});

  view.setColumns(cols);

  const colWidths = getColumnWidths(view);
  colWidths[0] = 220;  // Email column
  colWidths[1] = 260; // Name column      
  colWidths[2] = 160;  // Month & Year column
  colWidths[4] = 180;  // City column

  table.draw(view, {
    showRowNumber: true,
    width: '100%',
    height: '100%',
    allowHtml: true,
    columns: colWidths.map(w => ({ width: w })),
    cssClassNames: { tableCell: 'nowrap' }
  });
}  
    
// --- Event handlers ---
function onYearChange() {
  selections.year = document.getElementById('yearFilter').value;
  refreshFilterOptions();
  drawFilteredView();
}

function onMonthChange() {
  selections.month = document.getElementById('monthFilter').value;
  refreshFilterOptions();
  drawFilteredView();
}

function onDateChange() {
  selections.date = document.getElementById('dateFilter').value;
  refreshFilterOptions();
  drawFilteredView();
}

function onStateChange() {
  const selected = document.getElementById('stateFilter').value;
  selections.states = selected ? [selected.toLowerCase().trim()] : [];
  selections.city = '';
  refreshFilterOptions();
  drawFilteredView();
}

function onCityChange() {
  selections.city = document.getElementById('cityFilter').value;
  refreshFilterOptions();
  drawFilteredView();
}

function resetFilters() {
  selections.month = '';
  selections.date = '';
  const stateSel = document.getElementById('stateFilter');
  if (!stateSel.disabled) selections.states = [];
  selections.city = '';
  refreshFilterOptions();
  drawFilteredView();
}

// Minimal HTML escaping
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Expose globally in your type="module" script
window.deleteRow = async function deleteRow(rowId, name, email, rowState) {
  const profile = getUserProfile();
  const role = profile?.role || "state_admin";
  const allowedStates = getUserStates().map(s => String(s).toLowerCase().trim());
  const userStates = getUserStates().join(","); // e.g."maryland, virginia"
  
  const safeRowState = (rowState || "").toLowerCase().trim();

  // Authorization check
  if (role !== "global_admin" && !allowedStates.includes(safeRowState)) {
    alert(`You are not authorized to delete rows for ${rowState || "Unknown State"}.`);
    return;
  }

  if (!confirm(`Are you sure you want to delete ${name} (${email})?`)) return;

  const url = "https://script.google.com/macros/s/AKfycbxo6Ym-YWoqoJX_jugLJq4I7UwqbsKAaBGUpHvxmjpiWkN0u1KIulWWirqRkbugGpg9/exec"
    + "?rowId=" + encodeURIComponent(rowId)
    + "&userEmail=" + encodeURIComponent(profile.email)
    + "&userRole=" + encodeURIComponent(role)
    + "&userStates=" + encodeURIComponent(userStates);

  try {
    const response = await fetch(url);
    const result = await response.text();
    alert(result);

    // âœ… Reload fresh data from sheet
    reloadData(() => {
      refreshFilterOptions();
      drawFilteredView();
    });
  } catch (err) {
    alert("Delete failed: " + err.message);
  }
};

let currentRowId = null;

function closeModifyDialog() {
  document.getElementById("modifyModal").style.display = "none";
  currentRowId = null;
}

document.getElementById("modifyForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const profile = getUserProfile();
  const role = profile?.role || "state_admin";
  const userStates = getUserStates().join(",");

  const payload = {
    rowId: currentRowId,
    userEmail: profile.email,
    userRole: role,
    userStates: userStates,
    participants: document.getElementById("modParticipants").value,
    calls: document.getElementById("modCalls").value,
    tilawat: document.getElementById("modTilawat").value,
    naat: document.getElementById("modNaat").value,
    bayan: document.getElementById("modBayan").value,
    halqa: document.getElementById("modHalqa").value,
    sunnahs: document.getElementById("modSunnahs").value,
    dua: document.getElementById("modDua").value,
    booklet: document.getElementById("modBooklet").value
  };

  const url = "https://script.google.com/macros/s/AKfycbxo6Ym-YWoqoJX_jugLJq4I7UwqbsKAaBGUpHvxmjpiWkN0u1KIulWWirqRkbugGpg9/exec" + "?" + new URLSearchParams(payload).toString();

  try {
    const response = await fetch(url);
    const result = await response.text();
    alert(result);
    closeModifyDialog();
    reloadData(() => {
      refreshFilterOptions();
      drawFilteredView();
    });
  } catch (err) {
    alert("Modify failed: " + err.message);
  }
});
    
// To refresh the page after the successful deletion of the row(s)
    
function reloadData(callback) {
  document.getElementById('loading').style.display = "block"; // show spinner

  const queryString = "SELECT B, C, D, E, F, G, H, I, J, K, L, M, N, O, P";
  const query = new google.visualization.Query(sheetUrl + "&tq=" + encodeURIComponent(queryString));
  query.send(response => {
    document.getElementById('loading').style.display = "none"; // hide spinner

    if (response.isError()) {
      alert('Error reloading data: ' + response.getMessage());
      return;
    }
    masterData = response.getDataTable();
    if (callback) callback();
  });
}

window.openModifyDialog = function(rowId, state,
  participants, calls, tilawat, naat,
  bayan, halqa, sunnahs, dua, booklet) {

  const profile = getUserProfile();
  const role = profile?.role || "state_admin";
  const allowedStates = getUserStates().map(s => s.toLowerCase().trim());
  const safeRowState = (state || "").toLowerCase().trim();

  if (role !== "global_admin" && !allowedStates.includes(safeRowState)) {
    alert(`You are not authorized to modify rows for ${state || "Unknown State"}.`);
    return;
  }

  currentRowId = rowId;

  // Pre-fill modal fields
  document.getElementById("modParticipants").value = participants || "";
  document.getElementById("modCalls").value        = calls || "";
  document.getElementById("modTilawat").value      = tilawat || "";
  document.getElementById("modNaat").value         = naat || "";
  document.getElementById("modBayan").value        = bayan || "";
  document.getElementById("modHalqa").value        = halqa || "";
  document.getElementById("modSunnahs").value      = sunnahs || "";
  document.getElementById("modDua").value          = dua || "";
  document.getElementById("modBooklet").value      = booklet || "";

  document.getElementById("modifyModal").style.display = "block";
};
  
</script>
</body>
</html>     
