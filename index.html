<!DOCTYPE html>
<html>
<head>
  <title>Ijtima Performance Data</title>
  <meta charset="utf-8">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    h2 { margin-bottom: 12px; }
    .filters { display: flex; gap: 16px; flex-wrap: wrap; align-items: end; margin-bottom: 16px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    select, button, input { padding: 6px 10px; }
    .spacer { flex: 1; }
    #loginDiv { margin-bottom: 20px; }
  </style>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <h2>Ijtima Performance Data (Month → Date → State → City)</h2>

  <!-- Login Form -->
  <div id="loginDiv">
    <h3>Login</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- Dashboard (hidden until login) -->
  <div id="dashboardDiv" style="display:none;">
    <div class="filters">
      <div class="field">
        <label for="monthFilter">Month & Year</label>
        <select id="monthFilter" onchange="onMonthChange()"></select>
      </div>

      <div class="field">
        <label for="dateFilter">Date (Friday)</label>
        <select id="dateFilter" onchange="onDateChange()"></select>
      </div>

      <div class="field">
        <label for="stateFilter">State</label>
        <select id="stateFilter" onchange="onStateChange()"></select>
      </div>

      <div class="field">
        <label for="cityFilter">City</label>
        <select id="cityFilter" onchange="onCityChange()"></select>
      </div>

      <div class="spacer"></div>
      <button onclick="resetFilters()">Reset Filters</button>
    </div>

    <!-- Table container -->
    <div id="table_div"></div>
  </div>

  <!-- Dashboard Logic -->
  <script type="module">
    import { login, logout, getUserState } from './auth.js';

    google.charts.load('current', {'packages':['table']});
    google.charts.setOnLoadCallback(init);

    const sheetUrl = 'https://docs.google.com/spreadsheets/d/11FCt-Uhffya434cBpGsNyotV1dUrMP_hkpeoLjYisdo/gviz/tq?sheet=Sheet1&headers=1';

    const stateCityMap = {
      "California": ["Elk Grove, CA", "Riverside, CA", "Sacramento, CA", "Woodland, CA", "Yuba City, CA"],
      "Florida": ["Miami, FL", "Tampa, FL"],
      "Georgia": ["Lilburn, GA"],
      "Illinois": ["Chicago, IL", "Lombard, IL", "Bloomington, IL", "Skokie, IL", "Schaumburg, IL"],
      "Louisiana": ["New Orleans, LA", "St.Rose, LA"],
      "Maryland": ["Baltimore, MD", "Woodbridge, MD", "Ellicot City, MD"],
      "New York": ["Bronx, NY", "Brooklyn, NY", "Long Island, NY", "Queens, NY", "Valley Stream, NY"],
      "Pennsylvania": ["Langhorne, PA"],
      "Texas": ["Sugar Land, TX", "Wylie, TX"],
      "Virginia": ["Woodbridge, VA"],
      "Washington": ["Lynnwood, WA"]
    };

    let masterData = null;
    let table = null;
    const selections = { month: '', date: '', state: '', city: '' };

    // --- Login Button ---
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await login(email, password);
        const assignedState = getUserState();

        const stateSel = document.getElementById('stateFilter');
        if (assignedState) {
          selections.state = assignedState;
          stateSel.value = assignedState;
          stateSel.disabled = true;
        } else {
          alert("No assignedState found in profile");
        }

        document.getElementById('loginDiv').style.display = "none";
        document.getElementById('dashboardDiv').style.display = "block";

        refreshFilterOptions();
        drawFilteredView();
      } catch (err) {
        alert(err.message);
      }
    });

    // --- Logout Button ---
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await logout();
      selections.state = '';
      selections.city = '';
      const stateSel = document.getElementById('stateFilter');
      stateSel.disabled = false;
      stateSel.value = '';

      document.getElementById('loginDiv').style.display = "block";
      document.getElementById('dashboardDiv').style.display = "none";

      resetFilters();
    });


    // --- Dashboard Initialization ---
    function init() {
      const queryString = "SELECT D, E, F, G, H, I, J, K, L, M, N, O";
      const query = new google.visualization.Query(sheetUrl + "&tq=" + encodeURIComponent(queryString));
      query.send(handleInitialResponse);
    }

    function handleInitialResponse(response) {
      if (response.isError()) {
        alert('Error loading data: ' + response.getMessage());
        return;
      }
      masterData = response.getDataTable();

      masterData.setColumnLabel(0, "Month & Year");
      masterData.setColumnLabel(1, "Date (Friday)");
      masterData.setColumnLabel(2, "City");
      masterData.setColumnLabel(3, "Number of Participants");
      masterData.setColumnLabel(4, "Invitation through calls");
      masterData.setColumnLabel(5, "Intentions before Tilawat");
      masterData.setColumnLabel(6, "Intentions before Naat");
      masterData.setColumnLabel(7, "Duration of Bayan (minutes)");
      masterData.setColumnLabel(8, "Was Madani Halqa Conducted?");
      masterData.setColumnLabel(9, "Was Sunnahs and Manners taught?");
      masterData.setColumnLabel(10, "Was Learning/Memorizing Dua conducted?");
      masterData.setColumnLabel(11, "Was Pious Deed Booklet filled with everyone?");

      table = new google.visualization.Table(document.getElementById('table_div'));
      populateStateFilter();
      refreshFilterOptions();
      drawFilteredView();
    }

    function getVal(data, row, col) {
      return data.getFormattedValue(row, col) || data.getValue(row, col);
    }

    function populateStateFilter() {
      const stateSel = document.getElementById('stateFilter');
      stateSel.innerHTML = '<option value="">All States</option>';
      Object.keys(stateCityMap).forEach(state => {
        stateSel.innerHTML += `<option value="${state}">${state}</option>`;
      });
    }

    function refreshFilterOptions() {
      const months = new Set();
      const dates = new Set();
      const cities = new Set();

      for (let r = 0; r < masterData.getNumberOfRows(); r++) {
        const m = getVal(masterData, r, 0);
        const d = getVal(masterData, r, 1);
        const c = getVal(masterData, r, 2);

        const match =
          (!selections.month || m === selections.month) &&
          (!selections.date  || d === selections.date) &&
          (!selections.state || (stateCityMap[selections.state] && stateCityMap[selections.state].includes(c))) &&
          (!selections.city  || c === selections.city);

        if (match) {
          months.add(m);
          dates.add(d);
          cities.add(c);
        }
      }

      const monthSel = document.getElementById('monthFilter');
      monthSel.innerHTML = '<option value="">All Months</option>';
      [...months].sort().forEach(m => {
        monthSel.innerHTML += `<option value="${m}"${selections.month === m ? ' selected' : ''}>${m}</option>`;
      });

      const dateSel = document.getElementById('dateFilter');
      dateSel.innerHTML = '<option value="">All Dates</option>';
      [...dates].sort().forEach(d => {
        dateSel.innerHTML += `<option value="${d}"${selections.date === d ? ' selected' : ''}>${d}</option>`;
      });

      const citySel = document.getElementById('cityFilter');
      citySel.innerHTML = '<option value="">All Cities</option>';
      if (selections.state && stateCityMap[selections.state]) {
        stateCityMap[selections.state].forEach(c => {
          citySel.innerHTML += `<option value="${escapeHtml(c)}"${selections.city === c ? ' selected' : ''}>${escapeHtml(c)}</option>`;
        });
      } else {
        [...cities].sort().forEach(c => {
          citySel.innerHTML += `<option value="${escapeHtml(c)}"${selections.city === c ? ' selected' : ''}>${escapeHtml(c)}</option>`;
        });
      }
    }

    function drawFilteredView() {
      const view = new google.visualization.DataView(masterData);
      const rows = [];

      for (let r = 0; r < masterData.getNumberOfRows(); r++) {
        const m = getVal(masterData, r, 0);
        const d = getVal(masterData, r, 1);
        const c = getVal(masterData, r, 2);

        const match =
          (!selections.month || m === selections.month) &&
          (!selections.date  || d === selections.date) &&
          (!selections.state || (stateCityMap[selections.state] && stateCityMap[selections.state].includes(c))) &&
          (!selections.city  || c === selections.city);

        if (match) rows.push(r);
      }

      view.setRows(rows);
      table.draw(view, {showRowNumber: true, width: '100%', height: '100%'});
    }

    function onMonthChange() {
      selections.month = document.getElementById('monthFilter').value;
      refreshFilterOptions();
      drawFilteredView();
    }

    function onDateChange() {
      selections.date = document.getElementById('dateFilter').value;
      refreshFilterOptions();
      drawFilteredView();
    }

    function onStateChange() {
      selections.state = document.getElementById('stateFilter').value;
      selections.city = ''; // reset city when state changes
      refreshFilterOptions();
      drawFilteredView();
    }

    function onCityChange() {
      selections.city = document.getElementById('cityFilter').value;
      refreshFilterOptions();
      drawFilteredView();
    }

    function resetFilters() {
      selections.month = '';
      selections.date = '';
      // Keep state locked if logged in; otherwise clear
      const stateSel = document.getElementById('stateFilter');
      if (!stateSel.disabled) selections.state = '';
      selections.city = '';

      refreshFilterOptions();
      drawFilteredView();
    }

    // Minimal HTML escaping for safety
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
